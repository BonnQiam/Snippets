#Wiki  —— [[文件流]]

# 文本的基本操作

> 使用文件流类， 必须包含头文件 `<fstream>`

文件的使用过程如下：
1. 定义一个文件流对象
2. 打开文件
3. 对文件进行读写操作
4. 关闭文件

## （1）定义一个文件流对象

> C++在进行文件操作时，必须首先建立一个文件流，并把这个 流与实际的文件相关联，然后就可以按照要求进行读写操作。C++将文件流分为3类：

```cpp
ifstream infile; //用于与一个输入文件建立联系。用于文件输入操作
ofstream outfile;//用于与一个输出文件建立联系，用于文件输出操作
fstream iofile;//用于与一个输入输出文件建立联系，用于文件的输入和输出操作
```

这些类定义在头文件 `<fstream>`中。因此，在对文件进行输入 输出操作时，首先应该在开始包含 
```cpp
#include <fstream>
```

## （2）打开文件

> 文件在进行读写操作前，应先打开，其目的是为 文件流对象和特定的外存文件建立关联，并指定 文件的操作方式。打开文件的方式有以下两种： 
> - 使用 `open()`函数
> - 使用构造函数

### 使用open()函数

`open` 函数是 `ifstream`、`ofstream` / [[basic_ofstream]] 和 `fstream` / [[basic_fstream]] 类的成员函数。文件打开方式的一般格式为: 
```cpp
文件流对象名.open("文件名"，打开模式)；
```

e.g.
```cpp
infile.open("myfile1.txt"); //打开 myfile1.txt 用于读
outfile.open("myfile2.txt"); //打开 myfile2.txt 用于写 
iofile.open("myfile3.txt", ios::in| ios::out); // 位运算“|”或，组合条件 
//打开 myfile3.txt 用于读写
```

<center>
表12-1：ios定义文件打开方式
</center>

|标识常量|含义|
|---|---|
|`ios::in` |读方式打开文件 
|`ios::out` |写方式打开文件 
|`ios::ate` |打开文件时，文件指针指向文件末尾 
|`ios::app` |追加方式，向文件输出的内容追加到文件尾部 
|`ios::trunc` |删除文件现有内容（默认） 
|`ios::nocreate` |如果文件不存在，则打开操作失败 
|`ios::noreplace` |如果文件存在，则打开操作失败 
|`ios::binary` |二进制方式打开，默认为文本方式

说明：
- 每个被打开的文件都有一个文件指针，该指针的 初始位置由打开方式指定
- 文件每次读写都从文件指针的当前位置开始
- 当读出或写入一个字符，指针自动后移一个字节
- 当文件指针指向文件尾时，将遇到文件结束符 `EOF`（文件结束符占一个字节，其值为-1）。此时，流对象的成员函数 `eof()` 的值为非0值（一般为 1），表示文件结束

### 使用构造函数打开

使用构造函数同样也可以打开文件，与 `open()` 函数实现的功能一样。由于不同的输入输出类，其使用的格式分 别为：
```cpp
ifstream 对象名("文件名","打开方式"); 
ofstream 对象名("文件名","打开方式"); 
fstream 对象名("文件名","打开方式");
```

> 构造函数打开文件的方式，可看作是将定义流对象和打开文件可合二为一：

![](http://127.0.0.1:80/uploads/Snipaste_2022-08-21_18-13-26.png)

## （3） 对文件进行读写操作

与 cin 和 cout 的用法相同，如：
```cpp
infile >> x; 
outfile << y;
```

> 在对文件进行读写时，将文件看成字符流

![](http://127.0.0.1:80/uploads/Snipaste_2022-08-21_18-14-42.png)

## （4）关闭文件

文件读写完毕，必须关闭。关闭文件操作主要是 将缓冲区数据完整地写入文件，添加文件结束标 志，使文件流与对应的物理文件断开联系。关闭文件成员函数 格式 ：
```cpp
void ifstream::close( ); 
void ofstream::close( ); 
void fstream::close( );
```

如：
```cpp
infile.close(); //切断与输入文件 myfile1.txt 的联系 
outfile.close(); //切断与输出文件 myfile2.txt 的联系 
iofile.close(); //切断与输入输出文件 myfile3.txt 的联系
```

# 顺序文件的访问

文本文件用文本文件流进行读/写  ——  文本文件是顺序存取文件；文本文件用默认方式打开

> 文本文件本身没有什么纪录逻辑结构。为了便于识别，文本文件中通常一个记录放一 行（用换行符分隔的逻辑行）。记录的每一个数据项之间可以用空白符、换行 符、制表符等作为分隔符 。


涉及到字符串的文件读写：

![](http://127.0.0.1:80/uploads/Snipaste_2022-08-21_18-17-06.png)

简单例子：
- 12-3-1.cpp ：写文本文件： 建立一个包含学生学号、姓名、成绩的文 本文件。一行放一个学生纪录
- 12-3-2.cpp ：读文本文件： 读取由例12-3-1建立的文本文件，在屏幕显 示学生纪录，以及最高分数，最低分数和 平均分数
- 12-3-3.cpp：向文件追加记录 ：一个文本文件一旦建立之后，不能随意插入数 据。但可以在文件尾部追加数据。 向文件追加数据以app方式打开。

## 二进制文件

> 二进制文件不同于文本文件以ASCII代码存放数据，它将内 存中数据存储形式不加转换地传送到文件中：
> - 对于字符来说，二进制表示与文本表示是一样的，即字 符的ASCII码的二进制表示
> - 但对于数字来说，由于不需要转换，用二进制格式保存 数字速度更快，占用空间更小，并可以大块地存储数据 
> 因为二进制的存储格式和内存格式一致，存储长度仅与数据类型相关，所以文件的数据易于修改而不损坏其他数据

例如：一个double类型数据，不管是3.14还是3.14159的 二进制表示都是8字节。因此二进制文件又称为**类型文件**

关于二进制文件的说明：
- 打开二进制文件用binary方式
	- 从二进制文件流读取数据用istream的函数read
	- 向二进制文件流写入数据用ostream的函数write
- 二进制文件是随机存取文件：C++的流指针在字节流中移动，指针指向的位置，对数据既可读又可写

read和write函数的原型：
```cpp
istream& read(char *buffer, int len); 
ostream& write(const char *buffer, int len)
```

> 由于二进制文件中的数据不是ASCII码，故不能 直接对其读写，必须要通过特定的函数予以转换

读取函数：
```cpp
// infile 为 输入文件对象名
infile.read(char *,  //数据进入的内存地址 
			int //一次读入的字节数
			)
```

```cpp
int i; 
infile.read((char *)&i,
			sizeof(int)
			);//从文件中读取一个整型数到 i


```

e.g.
```cpp
int i; infile.read((char *)&i, //地址要强制转换成字符
			sizeof(int));//从文件中读取一个整型数到i
```

```cpp
int a[10]; 
infile.read((char *)a, 10*sizeof(int));//从文件中读取十个整型数到a
```

输出函数：
```cpp
// outfile 为 输出文件对象名
outfile.write( char *, //要输出的数据在内存中的地址
			  int  // 一次输出的字节数 
			  );
```

e.g.
```cpp
int i=4; 
outfile.write((char *)&i,  // 地址要强制转换成字符
			  sizeof(int));//向文件输出一个整型数i
```

```cpp
int a[10]={0,1,2,3,4,5,6,7,8,9}; 
outfile.write((char *)a, 10*sizeof(int));//向文件输出一个整型数组a
```

# 随机文件的访问

## 流指针

文件打开后，系统自动生成两个隐含的流指针—读指针和写指针

![](http://127.0.0.1:80/uploads/Snipaste_2022-08-21_19-19-26.png)

istream、ostream的成员函数可以返回指针的值或移动指针：
- 用追加方式`(ate，app)`打开文件时，流指针指向文件末尾；
- 用其他方式打开时，流指针指向文件的第一个字节

> 文件的读/写从流指针所指的位置开始，每完成一次读/写操 作后，流指针自动移到下一个读/写分量的起始位置

<center>
表12-2 与文件流指针有关的成员函数
</center>

|成员函数|作用|
|---|---|
|gcount()|返回最后一次输入所读入的字节数 
|tellg() |返回输入文件流指针的当前位置 
|tellp() |返回输出文件流指针的当前位置 
|seekg（文件中的位置）|将输入文件流指针移到指定位置 
|seekg（位移量，参照位置） |以参照位置为基础移动若干字节 
|seekp（文件中的位置） |将输出文件流指针移动到指定位置 
|seekp（位移量，参照位置）| 以参照位置为基础移动若字节

参数中的位置和位移量均为长整型，以字节为单位，参照位置：
- ios::beg—文件开始，默认值 
- ios::cur—当前位置 
- ios::end—文件末

e.g.
```cpp
infile.seekg(int); //将文件指针移动到由参数指定的字节处
infile.seekg(100); //将文件指针移动到距离文件头100个字节处
infile.seekg(int,  //移动的字节数
			 ios::_dir // 相对位置
			 ;
/*
_dir —— 
- beg: 文件头 
- cur: 当前位置 
- end: 文件尾
*/
```

```cpp
infile.seekg(100, ios::beg);//移动到距文件头100个字节 
infile.seekg(-100, ios::cur);//移动到距当前位置前100个字节 
infile.seekg(-500, ios::end);//移动到距文件尾前500个字节
```